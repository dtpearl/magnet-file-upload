<!--
  Photo Upload Core
  Shared JavaScript for photo upload components.
  Include this section after photo-upload-styles and before variant sections.
-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
<script>
  window.PhotoUploader = (function() {
    const SAFE_AREA_PERCENTAGE = 0.9;
    const SAFE_AREA_BORDER = "rgba(0, 120, 255, 0.8)";

    function openModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal && modal.parentNode !== document.body) {
        document.body.appendChild(modal);
      }
      modal.classList.add("active");
    }

    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove("active");
    }

    function generateSessionId() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      const hh = String(now.getHours()).padStart(2, "0");
      const min = String(now.getMinutes()).padStart(2, "0");
      const rand = Math.floor(1000 + Math.random() * 9000);
      return `${yyyy}${mm}${dd}-${hh}${min}-${rand}`;
    }

    async function uploadToCloudinary(file, fileName) {
      const url = "https://api.cloudinary.com/v1_1/djzc7ih0g/image/upload";
      const form = new FormData();
      form.append("upload_preset", "shopify-magnets");
      form.append("folder", "shopify_uploads");
      form.append("tags", "order_pending");
      form.append("public_id", fileName);
      form.append("file", file);
      const res = await fetch(url, { method: "POST", body: form });
      if (!res.ok) throw new Error("Upload failed");
      return res.json();
    }

    function init(config) {
      const {
        productId,
        maxFiles,
        aspectRatio,
        landscapeRatio,
        portraitRatio,
        hasOrientation
      } = config;

      let selectedFiles = [];
      let croppedFiles = [];
      let cropOrientations = [];
      let currentCropperInstance = null;
      let currentCropIndex = -1;
      let currentOrientation = "landscape";

      const actualFileInput = document.getElementById(`actual-file-input-${productId}`);
      const customUploadButton = document.getElementById(`custom-upload-button-${productId}`);
      const removeAllFilesButton = document.getElementById("remove-all-files-btn");
      const uploadStatus = document.getElementById(`upload-status-${productId}`);
      const mediaUploadStatus = document.getElementById(`media-upload-status-${productId}`);
      const fileCountDisplay = document.getElementById(`file-count-display-${productId}`);
      const imageToCrop = document.getElementById("image-to-crop");
      const cropCancel = document.getElementById("crop-cancel");
      const cropApply = document.getElementById("crop-apply");
      const uploadButton = document.getElementById("upload-btn-main");
      const uploadConfirmEl = document.getElementById("upload-confirm");
      const confirmUploadBtn = document.getElementById("confirm-upload-btn");
      const confirmCancelBtn = document.getElementById("confirm-cancel-btn");
      const removeAllConfirmEl = document.getElementById("remove-all-confirm");
      const removeAllConfirmBtn = document.getElementById("remove-all-confirm-btn");
      const removeAllCancelBtn = document.getElementById("remove-all-cancel-btn");
      const selectPhotosButton = document.getElementById(`select-photos-button-${productId}`);
      const editModalCloseBtn = document.getElementById("edit-modal-close-btn");
      const footerActionsEl = document.querySelector(".modal-footer-actions");
      const uploadArea = document.querySelector(".upload-area");
      const uploadProgressEl = document.getElementById("upload-progress");
      const progressBarFill = document.getElementById("progress-bar-fill");
      const progressText = document.getElementById("progress-text");
      const uploadCompleteEl = document.getElementById("upload-complete");
      const processingIndicator = document.getElementById("processing-indicator");
      const processingTextEl = processingIndicator.querySelector(".processing-text");

      // Orientation elements (rectangle only)
      const orientationLandscapeBtn = hasOrientation ? document.getElementById("orientation-landscape") : null;
      const orientationPortraitBtn = hasOrientation ? document.getElementById("orientation-portrait") : null;

      function getAspectRatio() {
        if (hasOrientation) {
          return currentOrientation === "landscape" ? landscapeRatio : portraitRatio;
        }
        return aspectRatio;
      }

      function getDefaultRatio() {
        return hasOrientation ? landscapeRatio : aspectRatio;
      }

      // Drag and drop
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "#e5e7eb";
      });
      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
      });
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
        const files = Array.from(e.dataTransfer.files);
        if (files.length) addFilesToFileInput(files);
      });

      customUploadButton.addEventListener("click", () => actualFileInput.click());

      removeAllFilesButton.addEventListener("click", () => {
        removeAllConfirmEl.classList.add("active");
        footerActionsEl.style.display = "none";
      });
      removeAllCancelBtn.addEventListener("click", () => {
        removeAllConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
      });
      removeAllConfirmBtn.addEventListener("click", () => {
        removeAllConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
        removeAllFiles();
      });

      uploadButton.addEventListener("click", () => {
        if (croppedFiles.length < maxFiles) {
          mediaUploadStatus.textContent = `You have ${croppedFiles.length} chosen images. Please select exactly ${maxFiles} images before uploading.`;
          return;
        }
        mediaUploadStatus.textContent = "";
        uploadConfirmEl.classList.add("active");
        footerActionsEl.style.display = "none";
      });

      confirmCancelBtn.addEventListener("click", () => {
        uploadConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
      });

      confirmUploadBtn.addEventListener("click", async () => {
        uploadConfirmEl.classList.remove("active");
        uploadButton.disabled = true;
        uploadButton.textContent = "Uploading...";
        footerActionsEl.style.display = "flex";
        removeAllFilesButton.style.display = "none";
        mediaUploadStatus.textContent = "";
        uploadProgressEl.classList.add("active");
        uploadCompleteEl.classList.remove("active");

        const sessionId = generateSessionId();
        let uploadedCount = 0;
        let hasError = false;

        for (let index = 0; index < croppedFiles.length; index++) {
          try {
            progressText.textContent = `Uploading ${index + 1} of ${croppedFiles.length}...`;
            progressBarFill.style.width = `${(index / croppedFiles.length) * 100}%`;
            await uploadToCloudinary(croppedFiles[index], `${sessionId}_${index + 1}`);
            uploadedCount++;
            progressBarFill.style.width = `${(uploadedCount / croppedFiles.length) * 100}%`;
          } catch (error) {
            hasError = true;
            break;
          }
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));
        uploadProgressEl.classList.remove("active");

        if (hasError) {
          mediaUploadStatus.textContent = `Upload failed on image ${uploadedCount + 1}. Please try again.`;
          uploadButton.disabled = false;
          uploadButton.textContent = "Upload";
          if (selectedFiles.length > 0) removeAllFilesButton.style.display = "block";
        } else {
          uploadCompleteEl.classList.add("active");
          uploadButton.textContent = "Done";
          uploadButton.disabled = false;
          selectPhotosButton.textContent = "Photos uploaded";
          document.dispatchEvent(new CustomEvent("photosUploaded"));
          uploadButton.onclick = () => closeModal(`select-photos-modal-${productId}`);
        }
      });

      function addFilesToFileInput(files) {
        const newFiles = Array.from(files);
        if (selectedFiles.length + newFiles.length > maxFiles) {
          uploadStatus.textContent = `You can only upload a maximum of ${maxFiles} images.`;
          return;
        }
        processNewFiles(newFiles);
      }

      actualFileInput.addEventListener("change", (e) => {
        addFilesToFileInput(Array.from(e.target.files));
      });

      // Orientation toggle (rectangle only)
      function updateOrientationToggle() {
        if (!hasOrientation) return;
        if (currentOrientation === "landscape") {
          orientationLandscapeBtn.classList.add("active");
          orientationPortraitBtn.classList.remove("active");
        } else {
          orientationLandscapeBtn.classList.remove("active");
          orientationPortraitBtn.classList.add("active");
        }
      }

      if (hasOrientation && orientationLandscapeBtn) {
        orientationLandscapeBtn.addEventListener("click", () => {
          if (!currentCropperInstance || currentOrientation === "landscape") return;
          currentOrientation = "landscape";
          updateOrientationToggle();
          currentCropperInstance.setAspectRatio(landscapeRatio);
          drawSafeArea();
        });
      }

      if (hasOrientation && orientationPortraitBtn) {
        orientationPortraitBtn.addEventListener("click", () => {
          if (!currentCropperInstance || currentOrientation === "portrait") return;
          currentOrientation = "portrait";
          updateOrientationToggle();
          currentCropperInstance.setAspectRatio(portraitRatio);
          drawSafeArea();
        });
      }

      function startCropping(index) {
        currentCropIndex = index;
        const file = selectedFiles[index];
        if (hasOrientation) {
          currentOrientation = cropOrientations[index] || "landscape";
          updateOrientationToggle();
        }
        const ratio = getAspectRatio();
        const objectUrl = URL.createObjectURL(file);

        imageToCrop.onload = function() {
          currentCropperInstance = new Cropper(imageToCrop, {
            aspectRatio: ratio,
            viewMode: 1,
            guides: true,
            autoCropArea: 0.8,
            movable: true,
            rotatable: true,
            scalable: true,
            zoomable: true,
            ready: () => drawSafeArea(),
            cropmove: () => drawSafeArea(),
          });
        };
        imageToCrop.src = objectUrl;
      }

      cropApply.addEventListener("click", () => {
        if (!currentCropperInstance) return;
        const cropData = currentCropperInstance.getData();
        const srcW = Math.round(cropData.width);
        const srcH = Math.round(cropData.height);
        const shortSide = Math.min(srcW, srcH);
        const scale = Math.min(2000 / shortSide, 1);
        const width = Math.round(srcW * scale);
        const height = Math.round(srcH * scale);

        const croppedCanvas = currentCropperInstance.getCroppedCanvas({
          width, height, fillColor: "#fff",
        });

        if (hasOrientation) cropOrientations[currentCropIndex] = currentOrientation;

        croppedCanvas.toBlob((blob) => {
          croppedFiles[currentCropIndex] = new File([blob], selectedFiles[currentCropIndex].name, {
            type: "image/jpeg",
            lastModified: new Date().getTime(),
          });
          currentCropperInstance.destroy();
          currentCropperInstance = null;
          closeEditModal();
        }, "image/jpeg", 0.92);
      });

      cropCancel.addEventListener("click", () => {
        if (currentCropperInstance) {
          currentCropperInstance.destroy();
          currentCropperInstance = null;
        }
        closeEditModal();
      });

      editModalCloseBtn.addEventListener("click", () => {
        if (currentCropperInstance) {
          currentCropperInstance.destroy();
          currentCropperInstance = null;
        }
        closeEditModal();
      });

      function closeEditModal() {
        const cropModal = document.getElementById("edit-photos-modal");
        cropModal.classList.remove("active");
        imageToCrop.src = "";
        currentCropIndex = -1;
        closeModal("edit-photos-modal");
        processThumbnails();
      }

      function updateUploadUI() {
        fileCountDisplay.textContent = `${selectedFiles.length}/${maxFiles} images selected`;
        const removeAllFilesBtn = document.querySelector(".remove-all-files-btn");
        removeAllFilesBtn.style.display = selectedFiles.length === 0 ? "none" : "block";
        if (selectedFiles.length === maxFiles) {
          uploadArea.style.display = "none";
          document.querySelector(".post-selection-info").style.display = "flex";
          uploadButton.disabled = false;
        } else {
          uploadArea.style.display = "flex";
          document.querySelector(".post-selection-info").style.display = "none";
          uploadButton.disabled = true;
        }
      }

      async function compressImage(file, index, minShortSide = 2000, quality = 0.92) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error("Failed to read file"));
          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");
              const shortSide = Math.min(img.width, img.height);
              const scale = Math.min(minShortSide / shortSide, 1);
              canvas.width = Math.round(img.width * scale);
              canvas.height = Math.round(img.height * scale);
              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
              canvas.toBlob((blob) => resolve(blob), "image/jpeg", quality);
            };
          };
          reader.readAsDataURL(file);
        });
      }

      function createDefaultCrop(blob) {
        return new Promise((resolve) => {
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            URL.revokeObjectURL(url);
            const targetRatio = getDefaultRatio();
            let cropWidth, cropHeight;
            if (img.width / img.height > targetRatio) {
              cropHeight = img.height;
              cropWidth = cropHeight * targetRatio;
            } else {
              cropWidth = img.width;
              cropHeight = cropWidth / targetRatio;
            }
            const canvas = document.createElement("canvas");
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            const ctx = canvas.getContext("2d");
            const sx = (img.width - cropWidth) / 2;
            const sy = (img.height - cropHeight) / 2;
            ctx.drawImage(img, sx, sy, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
            canvas.toBlob((croppedBlob) => resolve(croppedBlob), "image/jpeg", 0.92);
          };
          img.src = url;
        });
      }

      async function processNewFiles(files) {
        if (files.length === 0) return;
        processingTextEl.textContent = files.length === 1
          ? "Processing image..."
          : `Processing image 1 of ${files.length}...`;
        processingIndicator.classList.add("active");

        const initialLength = selectedFiles.length;
        for (let i = 0; i < files.length; i++) {
          if (files.length > 1) {
            processingTextEl.textContent = `Processing image ${i + 1} of ${files.length}...`;
          }
          const indexToInsert = initialLength + i;
          const compressed = await compressImage(files[i], indexToInsert);
          selectedFiles[indexToInsert] = compressed;
          croppedFiles[indexToInsert] = await createDefaultCrop(compressed);
          if (hasOrientation) cropOrientations[indexToInsert] = "landscape";
        }

        processingIndicator.classList.remove("active");
        processThumbnails();
        updateUploadUI();
      }

      function processThumbnails() {
        const placeholderContainer = document.querySelector(".thumbnail-container");
        const mainContainer = document.querySelector(".main-thumbnail-container");
        if (placeholderContainer) placeholderContainer.innerHTML = "";
        if (mainContainer) mainContainer.innerHTML = "";

        const maxFilesAdded = selectedFiles.length === maxFiles;
        const container = maxFilesAdded ? mainContainer : placeholderContainer;
        const containers = new Array(selectedFiles.length);
        let imagesLoaded = 0;

        selectedFiles.forEach((file, index) => {
          const sourceFile = croppedFiles[index] || file;
          const reader = new FileReader();
          reader.onerror = () => {
            imagesLoaded++;
            if (imagesLoaded === selectedFiles.length) {
              containers.forEach((c) => { if (c) container.appendChild(c); });
            }
          };
          reader.onload = (e) => {
            const actionButtons = document.createElement("div");
            actionButtons.className = "thumbnail-action-buttons";

            const editBtn = document.createElement("button");
            editBtn.className = "thumbnail-action-btn";
            editBtn.title = "Edit";
            editBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none"><path d="M4 13.5V16h2.5l7.06-7.06-2.5-2.5L4 13.5z" stroke="currentColor" stroke-width="1.5"/><path d="M14.06 6.44a1.5 1.5 0 0 0 0-2.12l-1.38-1.38a1.5 1.5 0 0 0-2.12 0l-1.06 1.06 3.5 3.5 1.06-1.06z" stroke="currentColor" stroke-width="1.5"/></svg>`;
            editBtn.onclick = (ev) => {
              ev.stopPropagation();
              openModal("edit-photos-modal");
              startCropping(index);
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "thumbnail-action-btn";
            deleteBtn.title = "Remove";
            deleteBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none"><path d="M6 8v6m4-6v6m4-10v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4m5-2h-2a2 2 0 0 0-2 2v2h8V4a2 2 0 0 0-2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            deleteBtn.onclick = (ev) => {
              ev.stopPropagation();
              removeFile(index);
            };

            actionButtons.appendChild(editBtn);
            actionButtons.appendChild(deleteBtn);

            const imgContainer = document.createElement("div");
            imgContainer.classList.add(maxFilesAdded ? "main-thumbnail-img-container" : "placeholder-thumbnail-img-container");
            imgContainer.style.position = "relative";
            imgContainer.style.display = "inline-flex";

            const imgElement = document.createElement("img");
            imgElement.src = e.target.result;
            imgElement.classList.add(maxFilesAdded ? "main-thumbnail" : "placeholder-thumbnail");
            imgElement.onclick = (ev) => {
              ev.stopPropagation();
              openModal("edit-photos-modal");
              startCropping(index);
            };

            imgContainer.appendChild(imgElement);
            imgContainer.appendChild(actionButtons);
            containers[index] = imgContainer;
            imagesLoaded++;

            if (imagesLoaded === selectedFiles.length) {
              containers.forEach((c) => { if (c) container.appendChild(c); });
              if (maxFilesAdded) {
                const images = container.querySelectorAll("img");
                let renderedCount = 0;
                images.forEach((img) => {
                  if (img.complete) {
                    renderedCount++;
                    if (renderedCount === images.length) handleSafeAreaOverlay();
                  } else {
                    img.onload = () => {
                      renderedCount++;
                      if (renderedCount === images.length) handleSafeAreaOverlay();
                    };
                  }
                });
              }
            }
          };
          reader.readAsDataURL(sourceFile);
        });
      }

      function handleSafeAreaOverlay() {
        const thumbnails = document.querySelectorAll(".main-thumbnail-img-container");
        thumbnails.forEach((thumbnail) => {
          const img = thumbnail.querySelector("img");
          const cW = thumbnail.clientWidth, cH = thumbnail.clientHeight;
          const iW = img.clientWidth, iH = img.clientHeight;
          const imgLeft = (cW - iW) / 2, imgTop = (cH - iH) / 2;
          const safeW = iW * SAFE_AREA_PERCENTAGE, safeH = iH * SAFE_AREA_PERCENTAGE;
          const safeLeft = imgLeft + (iW - safeW) / 2, safeTop = imgTop + (iH - safeH) / 2;
          const oc = "rgba(0, 0, 0, 0.25)";

          const topO = document.createElement("div");
          topO.classList.add("safe-area-overlay");
          topO.style.cssText = `position:absolute;top:0;left:0;right:0;height:${safeTop}px;background:${oc};pointer-events:none;z-index:1;`;
          thumbnail.appendChild(topO);

          const bottomO = document.createElement("div");
          bottomO.classList.add("safe-area-overlay");
          bottomO.style.cssText = `position:absolute;bottom:0;left:0;right:0;height:${cH - safeTop - safeH}px;background:${oc};pointer-events:none;z-index:1;`;
          thumbnail.appendChild(bottomO);

          const leftO = document.createElement("div");
          leftO.classList.add("safe-area-overlay");
          leftO.style.cssText = `position:absolute;top:${safeTop}px;left:0;width:${safeLeft}px;height:${safeH}px;background:${oc};pointer-events:none;z-index:1;`;
          thumbnail.appendChild(leftO);

          const rightO = document.createElement("div");
          rightO.classList.add("safe-area-overlay");
          rightO.style.cssText = `position:absolute;top:${safeTop}px;right:0;width:${cW - safeLeft - safeW}px;height:${safeH}px;background:${oc};pointer-events:none;z-index:1;`;
          thumbnail.appendChild(rightO);

          const border = document.createElement("div");
          border.classList.add("safe-area-overlay");
          border.style.cssText = `position:absolute;left:${safeLeft}px;top:${safeTop}px;width:${safeW}px;height:${safeH}px;border:2px dashed ${SAFE_AREA_BORDER};box-sizing:border-box;pointer-events:none;z-index:1;`;
          thumbnail.appendChild(border);
        });
      }

      window.addEventListener("resize", () => {
        const modal = document.querySelector(".select-photos-modal.active");
        if (modal) {
          document.querySelectorAll(".safe-area-overlay").forEach((el) => el.remove());
          handleSafeAreaOverlay();
        }
      });

      function drawSafeArea() {
        if (!currentCropperInstance) return;
        const existing = document.querySelector(".safe-print-container");
        if (existing) existing.remove();

        const cropBox = currentCropperInstance.getCropBoxData();
        const safeW = cropBox.width * SAFE_AREA_PERCENTAGE;
        const safeH = cropBox.height * SAFE_AREA_PERCENTAGE;
        const safeLeft = (cropBox.width * (1 - SAFE_AREA_PERCENTAGE)) / 2;
        const safeTop = (cropBox.height * (1 - SAFE_AREA_PERCENTAGE)) / 2;

        const container = document.createElement("div");
        container.className = "safe-print-container";
        container.style.cssText = `position:absolute;left:${cropBox.left}px;top:${cropBox.top}px;width:${cropBox.width}px;height:${cropBox.height}px;pointer-events:none;`;

        const label = document.createElement("div");
        label.textContent = "Safe Print Area";
        label.style.cssText = "position:absolute;top:-8px;left:4px;background:rgba(0,120,255,0.8);color:white;padding:2px 6px;font-size:12px;border-radius:3px;";
        container.appendChild(label);

        const area = document.createElement("div");
        area.className = "safe-print-area";
        area.style.cssText = `position:absolute;left:${safeLeft}px;top:${safeTop}px;width:${safeW}px;height:${safeH}px;border:2px dashed ${SAFE_AREA_BORDER};background:transparent;box-shadow:0 0 0 9999px rgba(0,0,0,0.25);pointer-events:none;z-index:2000;`;
        container.appendChild(area);

        document.querySelector(".cropper-container").appendChild(container);
      }

      function removeFile(index) {
        if (index < 0 || index >= selectedFiles.length) return;
        selectedFiles.splice(index, 1);
        croppedFiles.splice(index, 1);
        if (hasOrientation) cropOrientations.splice(index, 1);
        if (selectedFiles.length === 0) actualFileInput.value = "";
        processThumbnails();
        updateUploadUI();
      }

      function removeAllFiles() {
        selectedFiles = [];
        croppedFiles = [];
        cropOrientations = [];
        actualFileInput.value = "";
        processThumbnails();
        updateUploadUI();
      }
    }

    return { init, openModal, closeModal };
  })();
</script>
