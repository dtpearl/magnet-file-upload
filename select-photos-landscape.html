{% if product.metafields.custom.image_uploader_shape == 'rectangle' %}
<div class="file-upload-container" data-product-id="{{ product.id }}">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
  <!--
    CSS styling for photo selection code.
  -->
  <style>
    .button {
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .select-photos-button {
      font-family: Cardo, serif;
      text-transform: uppercase;
      letter-spacing: 0.225em;
      background-color: #95887a;
      opacity: 0.8;
      width: 100%;
      max-width: 440px;
    }
    .select-photos-button:hover {
      background-color: #95887a !important;
    }
    .upload-icon {
      width: 20px;
      height: 20px;
      stroke: white;
      margin-left: 1em;
    }

    .select-photos-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #f0e5d9;
      z-index: 1000;
    }

    .select-photos-modal.active {
      display: flex;
    }

    .edit-photos-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #f0e5d9;
      z-index: 1000;
    }

    .edit-photos-modal.active {
      display: flex;
    }

    .crop-container {
      height: 500px;
      background-color: #f0f0f0;
      overflow: hidden;
    }

    #image-to-crop {
      display: block;
      max-width: 100%;
    }

    .crop-controls {
      display: flex;
      justify-content: flex-end;
      padding: 15px 20px;
      gap: 10px;
      border-top: 1px solid #eee;
    }

    .crop-button {
      padding: 8px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      border: none;
    }

    .crop-button.cancel {
      background-color: #f0f0f0;
      color: #333;
    }

    .crop-button.apply {
      background-color: #374151;
      color: white;
    }

    .crop-button:hover {
      opacity: 0.9;
    }

    .orientation-toggle {
      display: flex;
      border-radius: 20px;
      overflow: hidden;
      background-color: #d6cec6;
      padding: 3px;
      margin-right: auto;
      gap: 2px;
    }

    .orientation-toggle-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 14px;
      border: none;
      border-radius: 16px;
      background-color: transparent;
      color: #7d7268;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition:
        background-color 0.2s,
        color 0.2s;
    }

    .orientation-toggle-btn:hover {
      color: #4b5563;
    }

    .orientation-toggle-btn.active {
      background-color: #95887a;
      color: white;
    }

    .orientation-toggle-btn.active:hover {
      background-color: #7d7268;
    }

    .orientation-toggle-btn svg {
      width: 14px;
      height: 14px;
    }

    .modal-header {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 24px;
      border-bottom: 1px solid #e5e7eb;
      width: 100%;
    }

    .modal-title-container {
      display: flex;
      width: 100%;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
      color: #374151;
      display: inline-block;
    }

    .close-btn {
      width: 48px;
      height: 48px;
      background-color: #6b7280;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      position: absolute;
      top: 24px;
      right: 48px;
    }

    .close-btn:hover {
      background-color: #4b5563;
    }

    .close-btn svg {
      width: 24px;
      height: 24px;
      color: white;
    }

    .modal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px;
      overflow: auto;
    }

    .content-subtitle {
      color: #6b7280;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .hidden-file-input {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }

    .upload-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 448px;
      width: 100%;
    }

    .upload-area:hover {
      cursor: grab;
    }

    .upload-text {
      text-align: center;
      margin-bottom: 32px;
    }

    .upload-text h3 {
      font-size: 36px;
      font-weight: 300;
      color: #374151;
      margin-bottom: 8px;
    }

    .upload-text .or-text {
      color: #9ca3af;
      font-size: 24px;
      margin-top: 24px;
    }

    .upload-status {
      color: #f00;
    }

    .upload-btn {
      background-color: #95887a;
      color: white;
      padding: 16px 32px;
      border: none;
      border-radius: 9999px;
      font-family: Cardo, serif;
      font-weight: 500;
      font-size: 14px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .upload-btn:hover {
      background-color: #7d7268;
    }

    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 448px;
      margin-top: 32px;
      padding-right: 80px;
    }

    .main-thumbnail-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 32px;
    }

    .thumbnail-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
    }

    .placeholder-thumbnail-img-container {
      margin: 8px;
      border-radius: 8px;
      width: 28%;
      max-width: 200px;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      background-color: #e3d9cf;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .placeholder-thumbnail {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: pointer;
      transition:
        transform 0.2s,
        box-shadow 0.2s;
    }

    .main-thumbnail-img-container {
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1 / 1;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      background-color: #e3d9cf;
      border-radius: 8px;
    }

    .main-thumbnail {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: pointer;
      transition:
        transform 0.2s,
        box-shadow 0.2s;
    }

    .post-selection-info {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      width: 100%;
      color: #6b7280;
      font-size: 16px;
    }

    .modal-footer {
      padding: 24px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: center;
      gap: 16px;
      flex-direction: column;
      width: 100%;
      align-items: center;
      margin-bottom: 96px;
    }

    .modal-footer-actions {
      display: flex;
      flex-direction: row;
      gap: 16px;
      justify-content: center;
      width: 100%;
    }

    .remove-all-files-btn {
      background-color: transparent;
      color: #6b7280;
      padding: 8px 24px;
      border: 1px solid #9ca3af;
      border-radius: 8px;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
    }

    .remove-all-files-btn:hover {
      background-color: #6b7280;
      color: white;
      border-color: #6b7280;
    }

    .add-to-cart-btn {
      background-color: #374151;
      color: white;
      padding: 8px 24px;
      border: none;
      border-radius: 8px;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .add-to-cart-btn:hover {
      background-color: #1f2937;
    }

    .add-to-cart-btn:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .upload-progress {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      width: 100%;
      max-width: 320px;
    }

    .upload-progress.active {
      display: flex;
    }

    .progress-bar-track {
      width: 100%;
      height: 6px;
      background-color: #c9bdb0;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar-fill {
      display: block;
      height: 100%;
      width: 0%;
      background-color: #95887a;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 14px;
      color: #6b7280;
    }

    .upload-complete {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      color: #374151;
    }

    .upload-complete.active {
      display: flex;
    }

    .upload-complete svg {
      width: 40px;
      height: 40px;
      color: #95887a;
    }

    .upload-complete p {
      font-size: 14px;
      margin: 0;
    }

    .upload-confirm {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .upload-confirm.active {
      display: flex;
    }

    .upload-confirm-text {
      font-size: 14px;
      color: #374151;
      text-align: center;
    }

    .upload-confirm-actions {
      display: flex;
      gap: 16px;
    }

    .confirm-upload-btn {
      background-color: #374151;
      color: white;
      padding: 8px 24px;
      border: none;
      border-radius: 8px;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 13px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .confirm-upload-btn:hover {
      background-color: #1f2937;
    }

    .confirm-cancel-btn {
      background-color: transparent;
      color: #6b7280;
      padding: 8px 24px;
      border: 1px solid #9ca3af;
      border-radius: 8px;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .confirm-cancel-btn:hover {
      background-color: #6b7280;
      color: white;
      border-color: #6b7280;
    }

    .thumbnail-action-buttons {
      position: absolute;
      bottom: 5%;
      right: 5%;
      display: flex;
      gap: 0.5em;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 2;
    }

    .main-thumbnail-img-container:hover .thumbnail-action-buttons,
    .placeholder-thumbnail-img-container:hover .thumbnail-action-buttons {
      opacity: 1;
    }

    .thumbnail-action-btn {
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      color: #fff;
      width: 2em;
      height: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .thumbnail-action-btn svg {
      width: 1em;
      height: 1em;
    }

    .processing-indicator {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 32px 0;
    }

    .processing-indicator.active {
      display: flex;
    }

    .processing-spinner {
      width: 32px;
      height: 32px;
    }

    .processing-text {
      font-size: 14px;
      color: #6b7280;
    }

    @media (max-width: 768px) {
      .select-photos-modal {
        flex-direction: column;
        align-items: stretch;
        overflow: auto;
      }
      .modal-content {
        overflow: unset;
        padding: 16px;
      }

      .preview-container {
        max-width: 100%;
        padding-right: 0;
      }

      .modal-header {
        padding: 16px;
      }

      .modal-title-container {
        justify-content: center;
        width: 100%;
      }

      .close-btn {
        width: 40px;
        height: 40px;
        top: 16px;
        right: 16px;
      }

      .close-btn svg {
        width: 20px;
        height: 20px;
      }

      .main-thumbnail-container {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 0 16px;
      }

      .placeholder-thumbnail-img-container {
        width: 30%;
        margin: 4px;
      }

      /* Make action buttons always visible and larger on touch devices */
      .thumbnail-action-buttons {
        opacity: 1;
        gap: 8px;
      }

      .thumbnail-action-btn {
        width: 36px;
        height: 36px;
        min-width: 36px;
        min-height: 36px;
      }

      .thumbnail-action-btn svg {
        width: 18px;
        height: 18px;
      }

      .upload-text h3 {
        font-size: 28px;
      }

      .upload-text .or-text {
        font-size: 18px;
      }

      .modal-footer {
        padding: 16px;
        margin-bottom: 48px;
      }

      .crop-container {
        height: 350px;
      }

      .orientation-toggle {
        margin-bottom: 10px;
      }

      .crop-controls {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    @media (max-width: 480px) {
      .main-thumbnail-container {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      .thumbnail-action-btn {
        width: 32px;
        height: 32px;
        min-width: 32px;
        min-height: 32px;
      }

      .thumbnail-action-btn svg {
        width: 16px;
        height: 16px;
      }

      .crop-container {
        height: 280px;
      }

      .orientation-toggle-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
  </style>

  <!--
    JavaScript for photo selection code.
  -->
  <script>
    const openModal = (modalId) => {
      const modal = document.getElementById(modalId);
      if (modal && modal.parentNode !== document.body) {
        document.body.appendChild(modal); // Move modal to body
      }
      modal.classList.add("active");
    };

    const closeModal = (modalId) => {
      const modal = document.getElementById(modalId);
      modal.classList.remove("active");
    };

    const initializeImageUploader = (productId) => {
      const MAX_FILES = 6;
      const LANDSCAPE_RATIO = 16 / 9;
      const PORTRAIT_RATIO = 9 / 16;

      const SAFE_AREA_PERCENTAGE = 0.9;
      const SAFE_AREA_BORDER = "rgba(0, 120, 255, 0.8)";

      let selectedFiles = [];
      let croppedFiles = [];
      let cropOrientations = [];

      let currentCropperInstance = null;
      let currentCropIndex = -1;
      let currentOrientation = "landscape";

      const actualFileInput = document.getElementById(
        `actual-file-input-${productId}`,
      );
      const customUploadButton = document.getElementById(
        `custom-upload-button-${productId}`,
      );
      const removeAllFilesButton =
        document.getElementById(`remove-all-files-btn`);
      const uploadStatus = document.getElementById(
        `upload-status-${productId}`,
      );
      const mediaUploadStatus = document.getElementById(
        `media-upload-status-${productId}`,
      );
      const fileCountDisplay = document.getElementById(
        `file-count-display-${productId}`,
      );
      const imageToCrop = document.getElementById("image-to-crop");
      const cropCancel = document.getElementById("crop-cancel");
      const cropApply = document.getElementById("crop-apply");
      const orientationLandscapeBtn = document.getElementById(
        "orientation-landscape",
      );
      const orientationPortraitBtn = document.getElementById(
        "orientation-portrait",
      );
      const uploadButton = document.getElementById("upload-btn-main");
      const uploadConfirmEl = document.getElementById("upload-confirm");
      const confirmUploadBtn = document.getElementById("confirm-upload-btn");
      const confirmCancelBtn = document.getElementById("confirm-cancel-btn");
      const removeAllConfirmEl = document.getElementById("remove-all-confirm");
      const removeAllConfirmBtn = document.getElementById(
        "remove-all-confirm-btn",
      );
      const removeAllCancelBtn = document.getElementById(
        "remove-all-cancel-btn",
      );
      const selectPhotosButton = document.getElementById(
        `select-photos-button-${productId}`,
      );
      const editModalCloseBtn = document.getElementById("edit-modal-close-btn");
      const footerActionsEl = document.querySelector(".modal-footer-actions");
      const uploadArea = document.querySelector(".upload-area");

      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "#e5e7eb";
      });

      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
        const files = Array.from(e.dataTransfer.files);
        if (files.length) {
          addFilesToFileInput(files);
        }
      });
      customUploadButton.addEventListener("click", function () {
        actualFileInput.click();
      });

      removeAllFilesButton.addEventListener("click", function () {
        removeAllConfirmEl.classList.add("active");
        footerActionsEl.style.display = "none";
      });

      removeAllCancelBtn.addEventListener("click", function () {
        removeAllConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
      });

      removeAllConfirmBtn.addEventListener("click", function () {
        removeAllConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
        removeAllFiles();
      });

      const generateSessionId = () => {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
        const hh = String(now.getHours()).padStart(2, "0");
        const min = String(now.getMinutes()).padStart(2, "0");
        const rand = Math.floor(1000 + Math.random() * 9000);
        return `${yyyy}${mm}${dd}-${hh}${min}-${rand}`;
      };

      const uploadToCloudinary = async (file, fileName) => {
        const url = "https://api.cloudinary.com/v1_1/djzc7ih0g/image/upload";
        const form = new FormData();
        form.append("upload_preset", "shopify-magnets");
        form.append("folder", "shopify_uploads");
        form.append("tags", "order_pending");
        form.append("public_id", fileName);
        form.append("file", file);
        const res = await fetch(url, { method: "POST", body: form });
        if (!res.ok) throw new Error("Upload failed");
        return res.json();
      };

      const uploadProgressEl = document.getElementById("upload-progress");
      const progressBarFill = document.getElementById("progress-bar-fill");
      const progressText = document.getElementById("progress-text");
      const uploadCompleteEl = document.getElementById("upload-complete");

      uploadButton.addEventListener("click", function () {
        if (croppedFiles.length < MAX_FILES) {
          mediaUploadStatus.textContent = `You have ${croppedFiles.length} chosen images. Please select exactly ${MAX_FILES} images before uploading.`;
          return;
        }

        mediaUploadStatus.textContent = "";
        uploadConfirmEl.classList.add("active");
        footerActionsEl.style.display = "none";
      });

      confirmCancelBtn.addEventListener("click", function () {
        uploadConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
      });

      confirmUploadBtn.addEventListener("click", async function () {
        uploadConfirmEl.classList.remove("active");
        uploadButton.disabled = true;
        uploadButton.textContent = "Uploading...";
        footerActionsEl.style.display = "flex";
        removeAllFilesButton.style.display = "none";
        mediaUploadStatus.textContent = "";
        uploadProgressEl.classList.add("active");
        uploadCompleteEl.classList.remove("active");

        const sessionId = generateSessionId();
        let uploadedCount = 0;
        let hasError = false;

        for (let index = 0; index < croppedFiles.length; index++) {
          const file = croppedFiles[index];
          try {
            progressText.textContent = `Uploading ${index + 1} of ${croppedFiles.length}...`;
            progressBarFill.style.width = `${(index / croppedFiles.length) * 100}%`;

            const response = await uploadToCloudinary(
              file,
              `${sessionId}_${index + 1}`,
            );
            uploadedCount++;

            progressBarFill.style.width = `${(uploadedCount / croppedFiles.length) * 100}%`;
          } catch (error) {
            hasError = true;
            break;
          }
        }

        await new Promise((resolve) => setTimeout(resolve, 1000));
        uploadProgressEl.classList.remove("active");

        if (hasError) {
          mediaUploadStatus.textContent = `Upload failed on image ${uploadedCount + 1}. Please try again.`;
          uploadButton.disabled = false;
          uploadButton.textContent = "Upload";
          if (selectedFiles.length > 0) {
            removeAllFilesButton.style.display = "block";
          }
        } else {
          uploadCompleteEl.classList.add("active");
          uploadButton.textContent = "Done";
          uploadButton.disabled = false;

          selectPhotosButton.textContent = "Photos uploaded";

          // Notify cart button control that photos are uploaded
          document.dispatchEvent(new CustomEvent("photosUploaded"));

          uploadButton.onclick = function () {
            closeModal(`select-photos-modal-${productId}`);
          };
        }
      });

      const addFilesToFileInput = (files) => {
        const newFiles = Array.from(files);
        if (selectedFiles.length + newFiles.length > MAX_FILES) {
          uploadStatus.textContent = `You can only upload a maximum of ${MAX_FILES} images.`;
          return;
        }
        processNewFiles(newFiles);
      };

      actualFileInput.addEventListener("change", function (e) {
        const filesToAdd = Array.from(e.target.files);
        addFilesToFileInput(filesToAdd);
      });

      const updateOrientationToggle = () => {
        if (currentOrientation === "landscape") {
          orientationLandscapeBtn.classList.add("active");
          orientationPortraitBtn.classList.remove("active");
        } else {
          orientationLandscapeBtn.classList.remove("active");
          orientationPortraitBtn.classList.add("active");
        }
      };

      const startCropping = (index) => {
        currentCropIndex = index;
        const file = selectedFiles[index];

        currentOrientation = cropOrientations[index] || "landscape";
        updateOrientationToggle();

        const aspectRatio =
          currentOrientation === "landscape" ? LANDSCAPE_RATIO : PORTRAIT_RATIO;

        const objectUrl = URL.createObjectURL(file);

        imageToCrop.onload = function () {
          currentCropperInstance = new Cropper(imageToCrop, {
            aspectRatio: aspectRatio,
            viewMode: 1,
            guides: true,
            autoCropArea: 0.8,
            movable: true,
            rotatable: true,
            scalable: true,
            zoomable: true,
            ready: function () {
              drawSafeArea();
            },
            cropmove: function () {
              drawSafeArea();
            },
          });
        };

        imageToCrop.src = objectUrl;
      };

      orientationLandscapeBtn.addEventListener("click", function () {
        if (!currentCropperInstance || currentOrientation === "landscape")
          return;

        currentOrientation = "landscape";
        updateOrientationToggle();

        currentCropperInstance.setAspectRatio(LANDSCAPE_RATIO);
        drawSafeArea();
      });

      orientationPortraitBtn.addEventListener("click", function () {
        if (!currentCropperInstance || currentOrientation === "portrait")
          return;

        currentOrientation = "portrait";
        updateOrientationToggle();

        currentCropperInstance.setAspectRatio(PORTRAIT_RATIO);
        drawSafeArea();
      });

      cropApply.addEventListener("click", function () {
        if (!currentCropperInstance) return;

        const cropData = currentCropperInstance.getData();
        const srcW = Math.round(cropData.width);
        const srcH = Math.round(cropData.height);
        const shortSide = Math.min(srcW, srcH);
        const scale = Math.min(2000 / shortSide, 1);
        const width = Math.round(srcW * scale);
        const height = Math.round(srcH * scale);

        const croppedCanvas = currentCropperInstance.getCroppedCanvas({
          width: width,
          height: height,
          fillColor: "#fff",
        });

        cropOrientations[currentCropIndex] = currentOrientation;

        croppedCanvas.toBlob(
          function (blob) {
            croppedFiles[currentCropIndex] = new File(
              [blob],
              selectedFiles[currentCropIndex].name,
              {
                type: "image/jpeg",
                lastModified: new Date().getTime(),
              },
            );

            currentCropperInstance.destroy();
            currentCropperInstance = null;
            closeEditModal();
          },
          "image/jpeg",
          0.92,
        );
      });

      cropCancel.addEventListener("click", function () {
        if (currentCropperInstance) {
          currentCropperInstance.destroy();
          currentCropperInstance = null;
        }
        closeEditModal();
      });

      editModalCloseBtn.addEventListener("click", function () {
        if (currentCropperInstance) {
          currentCropperInstance.destroy();
          currentCropperInstance = null;
        }
        closeEditModal();
      });

      const closeEditModal = () => {
        const cropModal = document.getElementById("edit-photos-modal");
        cropModal.classList.remove("active");
        imageToCrop.src = "";
        currentCropIndex = -1;
        closeModal("edit-photos-modal");
        processThumbnails();
      };

      const updateUploadUI = () => {
        fileCountDisplay.textContent = `${selectedFiles.length}/${MAX_FILES} images selected`;
        const uploadArea = document.querySelector(`.upload-area`);
        const postSelectionInfo = document.querySelector(
          ".post-selection-info",
        );
        const removeAllFilesBtn = document.querySelector(
          ".remove-all-files-btn",
        );
        if (selectedFiles.length === 0) {
          removeAllFilesBtn.style.display = "none";
        } else {
          removeAllFilesBtn.style.display = "block";
        }
        if (selectedFiles.length === MAX_FILES) {
          uploadArea.style.display = "none";
          postSelectionInfo.style.display = "flex";
          uploadButton.disabled = false;
        } else {
          uploadArea.style.display = "flex";
          postSelectionInfo.style.display = "none";
          uploadButton.disabled = true;
        }
      };

      const compressImage = async (
        file,
        index,
        minShortSide = 2000,
        quality = 0.92,
      ) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error("Failed to read file"));
          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;

            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");

              const shortSide = Math.min(img.width, img.height);
              const scale = Math.min(minShortSide / shortSide, 1);
              canvas.width = Math.round(img.width * scale);
              canvas.height = Math.round(img.height * scale);

              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

              canvas.toBlob(
                (blob) => {
                  resolve(blob);
                },
                "image/jpeg",
                quality,
              );
            };
          };
          reader.readAsDataURL(file);
        });
      };

      const createDefaultCrop = (blob) => {
        return new Promise((resolve) => {
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            URL.revokeObjectURL(url);
            const targetRatio = LANDSCAPE_RATIO;
            let cropWidth, cropHeight;
            if (img.width / img.height > targetRatio) {
              cropHeight = img.height;
              cropWidth = cropHeight * targetRatio;
            } else {
              cropWidth = img.width;
              cropHeight = cropWidth / targetRatio;
            }
            const canvas = document.createElement("canvas");
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            const ctx = canvas.getContext("2d");
            const sx = (img.width - cropWidth) / 2;
            const sy = (img.height - cropHeight) / 2;
            ctx.drawImage(
              img,
              sx,
              sy,
              cropWidth,
              cropHeight,
              0,
              0,
              cropWidth,
              cropHeight,
            );
            canvas.toBlob(
              (croppedBlob) => resolve(croppedBlob),
              "image/jpeg",
              0.92,
            );
          };
          img.src = url;
        });
      };

      const processingIndicator = document.getElementById(
        "processing-indicator",
      );
      const processingText =
        processingIndicator.querySelector(".processing-text");

      const processNewFiles = async (files) => {
        if (files.length === 0) return;

        processingText.textContent =
          files.length === 1
            ? "Processing image..."
            : `Processing image 1 of ${files.length}...`;
        processingIndicator.classList.add("active");

        const initialLength = selectedFiles.length;
        for (let i = 0; i < files.length; i++) {
          if (files.length > 1) {
            processingText.textContent = `Processing image ${i + 1} of ${files.length}...`;
          }
          const indexToInsert = initialLength + i;
          const compressed = await compressImage(files[i], indexToInsert);
          selectedFiles[indexToInsert] = compressed;

          croppedFiles[indexToInsert] = await createDefaultCrop(compressed);
          cropOrientations[indexToInsert] = "landscape";
        }

        processingIndicator.classList.remove("active");
        processThumbnails();
        updateUploadUI();
      };

      const processThumbnails = () => {
        const placeholderThumbnailContainer = document.querySelector(
          ".thumbnail-container",
        );
        const mainThumbnailContainer = document.querySelector(
          ".main-thumbnail-container",
        );

        if (placeholderThumbnailContainer) {
          placeholderThumbnailContainer.innerHTML = "";
        }
        if (mainThumbnailContainer) {
          mainThumbnailContainer.innerHTML = "";
        }

        const maxFilesAdded = selectedFiles.length === MAX_FILES;
        const thumbnailContainer = maxFilesAdded
          ? mainThumbnailContainer
          : placeholderThumbnailContainer;

        const containers = new Array(selectedFiles.length);

        let imagesLoaded = 0;
        selectedFiles.forEach((file, index) => {
          const sourceFile = croppedFiles[index] || file;
          const reader = new FileReader();
          reader.onerror = () => {
            imagesLoaded++;
            if (imagesLoaded === selectedFiles.length) {
              containers.forEach((container) => {
                if (container) thumbnailContainer.appendChild(container);
              });
            }
          };
          reader.onload = (e) => {
            const actionButtons = document.createElement("div");
            actionButtons.className = "thumbnail-action-buttons";

            const editBtn = document.createElement("button");
            editBtn.className = "thumbnail-action-btn";
            editBtn.title = "Edit";
            editBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none"><path d="M4 13.5V16h2.5l7.06-7.06-2.5-2.5L4 13.5z" stroke="currentColor" stroke-width="1.5"/><path d="M14.06 6.44a1.5 1.5 0 0 0 0-2.12l-1.38-1.38a1.5 1.5 0 0 0-2.12 0l-1.06 1.06 3.5 3.5 1.06-1.06z" stroke="currentColor" stroke-width="1.5"/></svg>`;
            editBtn.onclick = (ev) => {
              ev.stopPropagation();
              openModal(`edit-photos-modal`);
              startCropping(index);
            };

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "thumbnail-action-btn";
            deleteBtn.title = "Remove";
            deleteBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none"><path d="M6 8v6m4-6v6m4-10v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4m5-2h-2a2 2 0 0 0-2 2v2h8V4a2 2 0 0 0-2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            deleteBtn.onclick = (ev) => {
              ev.stopPropagation();
              removeFile(index);
            };

            actionButtons.appendChild(editBtn);
            actionButtons.appendChild(deleteBtn);
            const imgContainer = document.createElement("div");

            if (maxFilesAdded) {
              imgContainer.classList.add("main-thumbnail-img-container");
            } else {
              imgContainer.classList.add("placeholder-thumbnail-img-container");
            }

            imgContainer.style.position = "relative";
            imgContainer.style.display = "inline-flex";

            const imgElement = document.createElement("img");
            imgElement.src = e.target.result;
            imgElement.classList.add(
              maxFilesAdded ? "main-thumbnail" : "placeholder-thumbnail",
            );
            imgElement.onclick = (ev) => {
              ev.stopPropagation();
              openModal(`edit-photos-modal`);
              startCropping(index);
            };

            imgContainer.appendChild(imgElement);
            imgContainer.appendChild(actionButtons);

            containers[index] = imgContainer;
            imagesLoaded++;

            if (imagesLoaded === selectedFiles.length) {
              containers.forEach((container) => {
                if (container) thumbnailContainer.appendChild(container);
              });
              if (maxFilesAdded) {
                // Wait for all images to render before adding safe area overlays
                const images = thumbnailContainer.querySelectorAll("img");
                let renderedCount = 0;
                images.forEach((img) => {
                  if (img.complete) {
                    renderedCount++;
                    if (renderedCount === images.length) {
                      handleSafeAreaOverlay();
                    }
                  } else {
                    img.onload = () => {
                      renderedCount++;
                      if (renderedCount === images.length) {
                        handleSafeAreaOverlay();
                      }
                    };
                  }
                });
              }
            }
          };
          reader.readAsDataURL(sourceFile);
        });
      };

      const handleSafeAreaOverlay = () => {
        const thumbnailContainers = document.querySelectorAll(
          ".main-thumbnail-img-container",
        );
        thumbnailContainers.forEach((thumbnail) => {
          const thumbnailImgElement = thumbnail.querySelector("img");
          const containerWidth = thumbnail.clientWidth;
          const containerHeight = thumbnail.clientHeight;
          const imgWidth = thumbnailImgElement.clientWidth;
          const imgHeight = thumbnailImgElement.clientHeight;

          const imgLeft = (containerWidth - imgWidth) / 2;
          const imgTop = (containerHeight - imgHeight) / 2;

          const safeWidth = imgWidth * SAFE_AREA_PERCENTAGE;
          const safeHeight = imgHeight * SAFE_AREA_PERCENTAGE;

          const safeLeft = imgLeft + (imgWidth - safeWidth) / 2;
          const safeTop = imgTop + (imgHeight - safeHeight) / 2;

          const safeAreaDiv = document.createElement("div");
          safeAreaDiv.classList.add("safe-area-overlay");
          safeAreaDiv.style.position = "absolute";
          safeAreaDiv.style.left = `${safeLeft}px`;
          safeAreaDiv.style.top = `${safeTop}px`;
          safeAreaDiv.style.width = `${safeWidth}px`;
          safeAreaDiv.style.height = `${safeHeight}px`;
          safeAreaDiv.style.border = `2px dashed ${SAFE_AREA_BORDER}`;
          safeAreaDiv.style.background = "transparent";
          safeAreaDiv.style.boxShadow = `0 0 0 9999px rgba(0, 0, 0, 0.25)`;
          safeAreaDiv.style.pointerEvents = "none";
          thumbnail.appendChild(safeAreaDiv);
        });
      };

      window.addEventListener("resize", () => {
        const modal = document.querySelector(".select-photos-modal.active");
        if (modal) {
          document
            .querySelectorAll(".safe-area-overlay")
            .forEach((el) => el.remove());
          handleSafeAreaOverlay();
        }
      });

      function drawSafeArea() {
        if (!currentCropperInstance) return;

        const existingSafeAreaContainer = document.querySelector(
          ".safe-print-container",
        );
        if (existingSafeAreaContainer) {
          existingSafeAreaContainer.remove();
        }

        const cropBox = currentCropperInstance.getCropBoxData();

        const safeWidth = cropBox.width * SAFE_AREA_PERCENTAGE;
        const safeHeight = cropBox.height * SAFE_AREA_PERCENTAGE;

        const safeLeft = (cropBox.width * (1 - SAFE_AREA_PERCENTAGE)) / 2;
        const safeTop = (cropBox.height * (1 - SAFE_AREA_PERCENTAGE)) / 2;

        const safeAreaContainer = document.createElement("div");
        safeAreaContainer.className = "safe-print-container";
        safeAreaContainer.style.position = "absolute";
        safeAreaContainer.style.left = `${cropBox.left}px`;
        safeAreaContainer.style.top = `${cropBox.top}px`;
        safeAreaContainer.style.width = `${cropBox.width}px`;
        safeAreaContainer.style.height = `${cropBox.height}px`;
        safeAreaContainer.style.pointerEvents = "none";

        const safeArea = document.createElement("div");
        safeArea.className = "safe-print-area";
        safeArea.style.position = "absolute";
        safeArea.style.left = `${safeLeft}px`;
        safeArea.style.top = `${safeTop}px`;
        safeArea.style.width = `${safeWidth}px`;
        safeArea.style.height = `${safeHeight}px`;
        safeArea.style.border = `2px dashed ${SAFE_AREA_BORDER}`;
        safeArea.style.background = "transparent";
        safeArea.style.boxShadow = "0 0 0 9999px rgba(0, 0, 0, 0.25)";
        safeArea.style.pointerEvents = "none";
        safeArea.style.zIndex = "2000";

        const label = document.createElement("div");
        label.textContent = "Safe Print Area";
        label.style.position = "absolute";
        label.style.top = "-8px";
        label.style.left = "4px";
        label.style.backgroundColor = "rgba(0, 120, 255, 0.8)";
        label.style.color = "white";
        label.style.padding = "2px 6px";
        label.style.fontSize = "12px";
        label.style.borderRadius = "3px";
        safeAreaContainer.appendChild(label);

        safeAreaContainer.appendChild(safeArea);
        const cropperContainer = document.querySelector(".cropper-container");
        cropperContainer.appendChild(safeAreaContainer);
      }

      const removeFile = (index) => {
        if (index < 0 || index >= selectedFiles.length) return;

        selectedFiles.splice(index, 1);
        croppedFiles.splice(index, 1);
        cropOrientations.splice(index, 1);

        if (selectedFiles.length === 0) {
          actualFileInput.value = "";
        }

        processThumbnails();
        updateUploadUI();
      };

      const removeAllFiles = () => {
        selectedFiles = [];
        croppedFiles = [];
        cropOrientations = [];
        actualFileInput.value = "";
        processThumbnails();
        updateUploadUI();
      };
    };
    document.addEventListener("DOMContentLoaded", function () {
      const uploadContainers = document.querySelectorAll(
        ".file-upload-container",
      );
      uploadContainers.forEach((container) => {
        const productId = container.dataset.productId;
        if (productId) {
          initializeImageUploader(productId);
        }
      });
    });
  </script>
  <!--
    HTML for photo selection code.
  -->
  <button
    class="button select-photos-button"
    id="select-photos-button-{{ product.id }}"
    onclick="openModal(`select-photos-modal-{{ product.id }}`)"
  >
    Select photos
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="upload-icon"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M12 16V4m0 0l-4 4m4-4l4 4M4 16.5v1.75A2.25 2.25 0 006.25 20.5h11.5A2.25 2.25 0 0020 18.25V16.5"
      />
    </svg>
  </button>
</div>
<div id="select-photos-modal-{{ product.id }}" class="select-photos-modal">
  <button
    class="close-btn"
    onclick="closeModal(`select-photos-modal-{{ product.id }}`)"
    aria-label="Close modal"
    title="Close"
  >
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M6 18L18 6M6 6l12 12"
      ></path>
    </svg>
  </button>
  <div class="modal-content">
    <div class="main-thumbnail-container"></div>

    <div class="upload-area">
      <input
        title="File Input"
        type="file"
        id="actual-file-input-{{ product.id }}"
        class="hidden-file-input"
        accept="image/*"
        multiple
      />
      <div class="upload-text">
        <h3>drag & drop</h3>
        <h3>your photos</h3>
        <p class="or-text">or</p>
      </div>

      <button id="custom-upload-button-{{ product.id }}" class="upload-btn">
        Upload from camera roll or PC
      </button>
      <div id="upload-status-{{ product.id }}" class="upload-status"></div>
      <div id="file-count-display-{{ product.id }}" class="file-count">
        0/6 images selected
      </div>
      <div id="processing-indicator" class="processing-indicator">
        <svg class="processing-spinner" viewBox="0 0 50 50">
          <circle
            cx="25"
            cy="25"
            r="20"
            fill="none"
            stroke="#d6cec6"
            stroke-width="5"
          />
          <circle
            cx="25"
            cy="25"
            r="20"
            fill="none"
            stroke="#95887a"
            stroke-width="5"
            stroke-dasharray="31.4 94.2"
            stroke-linecap="round"
          >
            <animateTransform
              attributeName="transform"
              type="rotate"
              from="0 25 25"
              to="360 25 25"
              dur="0.8s"
              repeatCount="indefinite"
            />
          </circle>
        </svg>
        <span class="processing-text">Processing images...</span>
      </div>
    </div>
  </div>
  <div class="preview-container">
    <div class="modal-header">
      <div class="modal-title-container">
        <h2 class="modal-title">Selection preview</h2>
      </div>
      <p class="content-subtitle">Click pictures to resize or crop</p>
      <div class="thumbnail-container"></div>
    </div>
    <div class="post-selection-info">
      <div>
        Your 6 chosen images have been cropped to fit on rectangular magnets.
      </div>
      <div>
        The area outside the dotted lines will wrap around the edges of your
        magnets.
      </div>
      <div>Please review before placing your order.</div>
    </div>
    <div class="modal-footer">
      <div
        id="media-upload-status-{{ product.id }}"
        class="upload-status"
      ></div>
      <div id="upload-progress" class="upload-progress">
        <div
          class="progress-bar-track"
          style="
            width: 100%;
            height: 6px;
            background-color: #c9bdb0;
            border-radius: 3px;
            overflow: hidden;
          "
        >
          <div
            id="progress-bar-fill"
            class="progress-bar-fill"
            style="
              display: block;
              height: 100%;
              width: 0%;
              background-color: #95887a;
              border-radius: 3px;
              transition: width 0.3s ease;
            "
          ></div>
        </div>
        <span id="progress-text" class="progress-text">Uploading 0/6...</span>
      </div>
      <div id="upload-complete" class="upload-complete">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <p>Images uploaded successfully!</p>
      </div>
      <div id="remove-all-confirm" class="upload-confirm">
        <p class="upload-confirm-text">
          Remove all selected images? This cannot be undone.
        </p>
        <div class="upload-confirm-actions">
          <button id="remove-all-cancel-btn" class="confirm-cancel-btn">
            Go back
          </button>
          <button id="remove-all-confirm-btn" class="confirm-upload-btn">
            Yes, remove all
          </button>
        </div>
      </div>
      <div id="upload-confirm" class="upload-confirm">
        <p class="upload-confirm-text">
          Are your photos looking good? Once uploaded they cannot be changed.
        </p>
        <div class="upload-confirm-actions">
          <button id="confirm-cancel-btn" class="confirm-cancel-btn">
            Go back
          </button>
          <button id="confirm-upload-btn" class="confirm-upload-btn">
            Yes, upload
          </button>
        </div>
      </div>
      <div class="modal-footer-actions">
        <button id="remove-all-files-btn" class="remove-all-files-btn">
          Remove all files
        </button>
        <button id="upload-btn-main" class="add-to-cart-btn" disabled>
          Upload
        </button>
      </div>
    </div>
  </div>
  <div id="edit-photos-modal" class="edit-photos-modal">
    <div class="modal-header">
      <div class="modal-title-container">
        <h2 class="modal-title">Crop your image</h2>
        <button
          id="edit-modal-close-btn"
          class="close-btn"
          aria-label="Close modal"
          title="Close"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <p class="content-subtitle">Click pictures to resize or crop</p>
      <div class="crop-container">
        <img id="image-to-crop" src="" alt="Image to crop" />
      </div>
      <div class="crop-controls">
        <div class="orientation-toggle">
          <button
            id="orientation-landscape"
            class="orientation-toggle-btn active"
            title="Landscape (16:9)"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="2" y="6" width="20" height="12" rx="2" />
            </svg>
            Landscape
          </button>
          <button
            id="orientation-portrait"
            class="orientation-toggle-btn"
            title="Portrait (9:16)"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="6" y="2" width="12" height="20" rx="2" />
            </svg>
            Portrait
          </button>
        </div>
        <button id="crop-cancel" class="crop-button cancel">Cancel</button>
        <button id="crop-apply" class="crop-button apply">Apply Crop</button>
      </div>
      <div class="crop-info">
        <p>
          The dashed blue box indicates the safe print area. Content outside
          this area may be trimmed during printing and magnet construction.
        </p>
      </div>
    </div>
  </div>
  <!-- This website uses Cropper.js by Chen Fengyuan -->
</div>
{% endif %}
