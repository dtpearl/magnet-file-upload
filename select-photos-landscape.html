<div class="file-upload-container" data-product-id="{{ product.id }}">
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
  <!--
    CSS styling for photo selection code.
  -->
  <style>
    .button {
      color: #fff;
      border: none;
      cursor: pointer;
    }
    .select-photos-button {
      font-family: Cardo, serif;
      text-transform: uppercase;
      letter-spacing: 0.225em;
      background-color: #95887a;
      opacity: 0.8;
      width: 100%;
    }
    .select-photos-button:hover {
      background-color: #95887a !important;
    }
    .upload-icon {
      width: 20px;
      height: 20px;
      stroke: white;
      margin-left: 1em;
    }

    .select-photos-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #f0e5d9;
      z-index: 1000;
    }

    .select-photos-modal.active {
      display: flex;
    }

    .edit-photos-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #f0e5d9;
      z-index: 1000;
    }

    .edit-photos-modal.active {
      display: flex;
    }

    .crop-container {
      height: 500px;
      background-color: #f0f0f0;
      overflow: hidden;
    }

    #image-to-crop {
      display: block;
      max-width: 100%;
    }

    .crop-controls {
      display: flex;
      justify-content: flex-end;
      padding: 15px 20px;
      gap: 10px;
      border-top: 1px solid #eee;
    }

    .crop-button {
      padding: 8px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      border: none;
    }

    .crop-button.cancel {
      background-color: #f0f0f0;
      color: #333;
    }

    .crop-button.apply {
      background-color: #374151;
      color: white;
    }

    .crop-button:hover {
      opacity: 0.9;
    }

    .orientation-toggle {
      display: flex;
      border-radius: 20px;
      overflow: hidden;
      background-color: #d6cec6;
      padding: 3px;
      margin-right: auto;
      gap: 2px;
    }

    .orientation-toggle-btn {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 6px 14px;
      border: none;
      border-radius: 16px;
      background-color: transparent;
      color: #7d7268;
      cursor: pointer;
      font-weight: 500;
      font-size: 13px;
      transition:
        background-color 0.2s,
        color 0.2s;
    }

    .orientation-toggle-btn:hover {
      color: #4b5563;
    }

    .orientation-toggle-btn.active {
      background-color: #95887a;
      color: white;
    }

    .orientation-toggle-btn.active:hover {
      background-color: #7d7268;
    }

    .orientation-toggle-btn svg {
      width: 14px;
      height: 14px;
    }

    .modal-header {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      border-bottom: 1px solid #e5e7eb;
      width: 100%;
    }

    .modal-title-container {
      display: flex;
      width: 100%;
    }

    .modal-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: #374151;
      display: inline-block;
    }

    .close-btn {
      width: 3rem;
      height: 3rem;
      background-color: #6b7280;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s;
      position: absolute;
      top: 1.5rem;
      right: 3rem;
    }

    .close-btn:hover {
      background-color: #4b5563;
    }

    .close-btn svg {
      width: 1.5rem;
      height: 1.5rem;
      color: white;
    }

    .modal-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
      overflow: auto;
    }

    .content-subtitle {
      color: #6b7280;
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }

    .hidden-file-input {
      opacity: 0;
      position: absolute;
      z-index: -1;
    }

    .upload-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      max-width: 28rem;
      width: 100%;
    }

    .upload-area:hover {
      cursor: grab;
    }

    .upload-text {
      text-align: center;
      margin-bottom: 2rem;
    }

    .upload-text h3 {
      font-size: 2.25rem;
      font-weight: 300;
      color: #374151;
      margin-bottom: 0.5rem;
    }

    .upload-text .or-text {
      color: #9ca3af;
      font-size: 0.875rem;
      margin-top: 1.5rem;
    }

    .upload-status {
      color: #f00;
    }

    .upload-btn {
      background-color: #95887a;
      color: white;
      padding: 1rem 2rem;
      border: none;
      border-radius: 9999px;
      font-family: Cardo, serif;
      font-weight: 500;
      font-size: 0.875rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .upload-btn:hover {
      background-color: #7d7268;
    }

    .preview-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      max-width: 28rem;
      margin-top: 2rem;
      padding-right: 5rem;
    }

    .main-thumbnail-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      width: 100%;
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 2rem;
    }

    .thumbnail-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      width: 100%;
    }

    .placeholder-thumbnail-img-container {
      margin: 0.5rem;
      border-radius: 0.5rem;
      width: 28%;
      max-width: 200px;
      aspect-ratio: 1 / 1;
      overflow: hidden;
      background-color: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .placeholder-thumbnail {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: pointer;
      transition:
        transform 0.2s,
        box-shadow 0.2s;
    }

    .main-thumbnail-img-container {
      display: flex;
      align-items: center;
      justify-content: center;
      aspect-ratio: 1 / 1;
      width: 100%;
      max-width: 400px;
      overflow: hidden;
      background-color: #e5e7eb;
      border-radius: 0.5rem;
    }

    .main-thumbnail {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      cursor: pointer;
      transition:
        transform 0.2s,
        box-shadow 0.2s;
    }

    .post-selection-info {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      width: 100%;
      color: #6b7280;
      font-size: 1rem;
    }

    .modal-footer {
      padding: 1.5rem;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: center;
      gap: 1rem;
      flex-direction: column;
      width: 100%;
      align-items: center;
      margin-bottom: 6rem;
    }

    .modal-footer-actions {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      justify-content: center;
      width: 100%;
    }

    .remove-all-files-btn {
      background-color: transparent;
      color: #6b7280;
      padding: 0.5rem 1.5rem;
      border: 1px solid #9ca3af;
      border-radius: 0.5rem;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
      display: none;
    }

    .remove-all-files-btn:hover {
      background-color: #6b7280;
      color: white;
      border-color: #6b7280;
    }

    .add-to-cart-btn {
      background-color: #374151;
      color: white;
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .add-to-cart-btn:hover {
      background-color: #1f2937;
    }

    .add-to-cart-btn:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }

    .upload-progress {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      max-width: 20rem;
    }

    .upload-progress.active {
      display: flex;
    }

    .progress-bar-track {
      width: 100%;
      height: 6px;
      background-color: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background-color: #95887a;
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .upload-complete {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      color: #374151;
    }

    .upload-complete.active {
      display: flex;
    }

    .upload-complete svg {
      width: 2.5rem;
      height: 2.5rem;
      color: #95887a;
    }

    .upload-complete p {
      font-size: 0.9rem;
      margin: 0;
    }

    .upload-confirm {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
    }

    .upload-confirm.active {
      display: flex;
    }

    .upload-confirm-text {
      font-size: 0.9rem;
      color: #374151;
      text-align: center;
    }

    .upload-confirm-actions {
      display: flex;
      gap: 1rem;
    }

    .confirm-upload-btn {
      background-color: #374151;
      color: white;
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 0.5rem;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      font-size: 0.8rem;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .confirm-upload-btn:hover {
      background-color: #1f2937;
    }

    .confirm-cancel-btn {
      background-color: transparent;
      color: #6b7280;
      padding: 0.5rem 1.5rem;
      border: 1px solid #9ca3af;
      border-radius: 0.5rem;
      font-family: Cardo, serif;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .confirm-cancel-btn:hover {
      background-color: #6b7280;
      color: white;
      border-color: #6b7280;
    }

    .thumbnail-action-buttons {
      position: absolute;
      bottom: 5%;
      right: 5%;
      display: flex;
      gap: 0.5em;
      opacity: 0;
      transition: opacity 0.2s;
      z-index: 2;
    }

    .main-thumbnail-img-container:hover .thumbnail-action-buttons,
    .placeholder-thumbnail-img-container:hover .thumbnail-action-buttons {
      opacity: 1;
    }

    .thumbnail-action-btn {
      background: rgba(0, 0, 0, 0.6);
      border: none;
      border-radius: 50%;
      color: #fff;
      width: 2em;
      height: 2em;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .thumbnail-action-btn svg {
      width: 1em;
      height: 1em;
    }

    @media (max-width: 768px) {
      /* Tablets & small laptops */
      .select-photos-modal {
        flex-direction: column;
        align-items: stretch;
        overflow: auto;
      }
      .modal-content {
        overflow: unset;
      }

      .preview-container {
        max-width: 100%;
      }

      .modal-title-container {
        justify-content: center;
        width: 100%;
      }
    }
  </style>

  <!--
    JavaScript for photo selection code.
  -->
  <script>
    const openModal = (modalId) => {
      console.log(`Opening modal with ID: ${modalId}`);
      const modal = document.getElementById(modalId);
      if (modal && modal.parentNode !== document.body) {
        document.body.appendChild(modal); // Move modal to body
      }
      modal.classList.add("active");
    };

    const closeModal = (modalId) => {
      const modal = document.getElementById(modalId);
      modal.classList.remove("active");
    };

    const initializeImageUploader = (productId) => {
      const MAX_FILES = 6;
      const LANDSCAPE_RATIO = 16 / 9;
      const PORTRAIT_RATIO = 9 / 16;

      // Print safe area configuration - adjust these values as needed
      const SAFE_AREA_PERCENTAGE = 0.9; // 90% of the cropped area is considered "safe" for print
      const SAFE_AREA_COLOR = "rgba(255, 255, 255, 0.2)";
      const SAFE_AREA_BORDER = "rgba(0, 120, 255, 0.8)";
      let showSafeArea = true; // Default state for safe area visibility

      let selectedFiles = [];
      let croppedFiles = [];
      let cropOrientations = []; // Track orientation per image: 'landscape' or 'portrait'

      let currentCropperInstance = null;
      let currentCropIndex = -1;
      let currentOrientation = "landscape"; // Current orientation in crop modal

      const actualFileInput = document.getElementById(
        `actual-file-input-${productId}`,
      );
      const customUploadButton = document.getElementById(
        `custom-upload-button-${productId}`,
      );
      const removeAllFilesButton =
        document.getElementById(`remove-all-files-btn`);
      const uploadStatus = document.getElementById(
        `upload-status-${productId}`,
      );
      const mediaUploadStatus = document.getElementById(
        `media-upload-status-${productId}`,
      );
      const fileCountDisplay = document.getElementById(
        `file-count-display-${productId}`,
      );
      const imageToCrop = document.getElementById("image-to-crop");
      const cropCancel = document.getElementById("crop-cancel");
      const cropApply = document.getElementById("crop-apply");
      const orientationLandscapeBtn = document.getElementById(
        "orientation-landscape",
      );
      const orientationPortraitBtn = document.getElementById(
        "orientation-portrait",
      );
      const uploadButton = document.getElementById("upload-btn-main");
      const uploadConfirmEl = document.getElementById("upload-confirm");
      const confirmUploadBtn = document.getElementById("confirm-upload-btn");
      const confirmCancelBtn = document.getElementById("confirm-cancel-btn");
      const removeAllConfirmEl = document.getElementById("remove-all-confirm");
      const removeAllConfirmBtn = document.getElementById(
        "remove-all-confirm-btn",
      );
      const removeAllCancelBtn = document.getElementById(
        "remove-all-cancel-btn",
      );
      const selectPhotosButton = document.getElementById(
        `select-photos-button-${productId}`,
      );
      const editModalCloseBtn = document.getElementById("edit-modal-close-btn");
      const footerActionsEl = document.querySelector(".modal-footer-actions");
      const uploadArea = document.querySelector(".upload-area");

      // Highlight on drag over
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "#e5e7eb"; // Optional: visual feedback
      });

      // Remove highlight on drag leave
      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = ""; // Reset
      });

      // Handle drop
      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        uploadArea.style.backgroundColor = "";
        const files = Array.from(e.dataTransfer.files);
        if (files.length) {
          addFilesToFileInput(files);
        }
      });
      // Trigger file input when custom button is clicked
      customUploadButton.addEventListener("click", function () {
        actualFileInput.click();
      });

      removeAllFilesButton.addEventListener("click", function () {
        // Show remove-all confirmation UI, hide footer actions
        removeAllConfirmEl.classList.add("active");
        footerActionsEl.style.display = "none";
      });

      removeAllCancelBtn.addEventListener("click", function () {
        removeAllConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
      });

      removeAllConfirmBtn.addEventListener("click", function () {
        removeAllConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
        removeAllFiles();
      });

      // Generates a session ID like: "20240901-1530-4821"
      const generateSessionId = () => {
        const now = new Date();
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
        const hh = String(now.getHours()).padStart(2, "0");
        const min = String(now.getMinutes()).padStart(2, "0");
        const rand = Math.floor(1000 + Math.random() * 9000); // 4-digit random number
        return `${yyyy}${mm}${dd}-${hh}${min}-${rand}`;
      };

      const uploadToCloudinary = async (file, fileName) => {
        const url = "https://api.cloudinary.com/v1_1/djzc7ih0g/image/upload";
        const form = new FormData();
        form.append("upload_preset", "shopify-magnets");
        form.append("folder", "shopify_uploads");
        form.append("tags", "order_pending");
        form.append("public_id", fileName);
        form.append("file", file); // this can be your client-compressed Blob
        const res = await fetch(url, { method: "POST", body: form });
        if (!res.ok) throw new Error("Upload failed");
        return res.json(); // contains secure_url and public_id
      };

      const uploadProgressEl = document.getElementById("upload-progress");
      const progressBarFill = document.getElementById("progress-bar-fill");
      const progressText = document.getElementById("progress-text");
      const uploadCompleteEl = document.getElementById("upload-complete");

      // Upload button shows the confirmation UI
      uploadButton.addEventListener("click", function () {
        console.log("Upload button clicked");
        console.log({ selectedFiles, croppedFiles });

        if (croppedFiles.length < MAX_FILES) {
          mediaUploadStatus.textContent = `You have ${croppedFiles.length} chosen images. Please select exactly ${MAX_FILES} images before uploading.`;
          return;
        }

        mediaUploadStatus.textContent = "";
        // Show confirmation UI, hide the main footer actions
        uploadConfirmEl.classList.add("active");
        footerActionsEl.style.display = "none";
      });

      // "Go back" hides confirmation and restores footer actions
      confirmCancelBtn.addEventListener("click", function () {
        uploadConfirmEl.classList.remove("active");
        footerActionsEl.style.display = "flex";
      });

      // "Yes, upload" starts the actual upload
      confirmUploadBtn.addEventListener("click", async function () {
        // Hide confirmation UI
        uploadConfirmEl.classList.remove("active");

        // Show progress
        uploadButton.disabled = true;
        uploadButton.textContent = "Uploading...";
        footerActionsEl.style.display = "flex";
        removeAllFilesButton.style.display = "none";
        mediaUploadStatus.textContent = "";
        uploadProgressEl.classList.add("active");
        uploadCompleteEl.classList.remove("active");

        const sessionId = generateSessionId();
        let uploadedCount = 0;
        let hasError = false;

        for (let index = 0; index < croppedFiles.length; index++) {
          const file = croppedFiles[index];
          try {
            // Update progress
            progressText.textContent = `Uploading ${index + 1} of ${croppedFiles.length}...`;
            progressBarFill.style.width = `${(index / croppedFiles.length) * 100}%`;

            const response = await uploadToCloudinary(
              file,
              `${sessionId}_${index + 1}`,
            );
            console.log(`Uploaded file ${index + 1}:`, response);
            uploadedCount++;

            // Update progress bar to reflect completion
            progressBarFill.style.width = `${(uploadedCount / croppedFiles.length) * 100}%`;
          } catch (error) {
            console.error(`Error uploading file ${index + 1}:`, error);
            hasError = true;
            break;
          }
        }

        uploadProgressEl.classList.remove("active");

        if (hasError) {
          mediaUploadStatus.textContent = `Upload failed on image ${uploadedCount + 1}. Please try again.`;
          uploadButton.disabled = false;
          uploadButton.textContent = "Upload";
          if (selectedFiles.length > 0) {
            removeAllFilesButton.style.display = "block";
          }
        } else {
          // Show completion state
          uploadCompleteEl.classList.add("active");
          uploadButton.textContent = "Done";
          uploadButton.disabled = false;

          // Update the Select Photos button text
          selectPhotosButton.textContent = "Photos uploaded";

          // Clicking "Done" closes the modal
          uploadButton.onclick = function () {
            closeModal(`select-photos-modal-${productId}`);
          };

          // After all files are uploaded, redirect to cart with session ID
          // const cartUrl = `/cart/add?product_id={{ product.id }}&quantity=1&properties[Image Session ID]=${sessionId}`;
          // window.location.href = cartUrl;
        }
      });

      const addFilesToFileInput = (files) => {
        const newFiles = Array.from(files);
        // Check if adding these files would exceed the limit
        if (selectedFiles.length + newFiles.length > MAX_FILES) {
          uploadStatus.textContent = `You can only upload a maximum of ${MAX_FILES} images.`;
          return;
        }
        // Process and add new files
        processNewFiles(newFiles);
      };

      // Handle file selection
      actualFileInput.addEventListener("change", function (e) {
        const filesToAdd = Array.from(e.target.files);
        addFilesToFileInput(filesToAdd);
      });

      // Update orientation toggle UI
      const updateOrientationToggle = () => {
        if (currentOrientation === "landscape") {
          orientationLandscapeBtn.classList.add("active");
          orientationPortraitBtn.classList.remove("active");
        } else {
          orientationLandscapeBtn.classList.remove("active");
          orientationPortraitBtn.classList.add("active");
        }
      };

      // Start the cropping process for a specific file index
      const startCropping = (index) => {
        // if (index >= selectedFiles.length) {
        //   // All files processed, display the final previews
        //   displayImagePreviews();
        //   return;
        // }

        currentCropIndex = index;
        const file = selectedFiles[index];

        // Use saved orientation or default to landscape
        currentOrientation = cropOrientations[index] || "landscape";
        updateOrientationToggle();

        const aspectRatio =
          currentOrientation === "landscape" ? LANDSCAPE_RATIO : PORTRAIT_RATIO;

        // Create a URL for the image
        const objectUrl = URL.createObjectURL(file);

        // Set the image source and prepare the cropper
        imageToCrop.onload = function () {
          // Initialize cropper
          currentCropperInstance = new Cropper(imageToCrop, {
            aspectRatio: aspectRatio,
            viewMode: 1,
            guides: true,
            autoCropArea: 0.8,
            movable: true,
            rotatable: true,
            scalable: true,
            zoomable: true,
            ready: function () {
              // Add safe area indicator when cropper is ready
              if (showSafeArea) {
                drawSafeArea();
              }
            },
            cropmove: function () {
              // Remove existing safe area when moving the crop box
              if (showSafeArea) {
                drawSafeArea();
              }
            },
          });
          /*
          Other methods that can be used with the cropper instance:
          cropend: function () {
            // Code to execute after cropping ends
          },
          zoom: function () {
            // Code to execute when zooming
          }
          */

          // Show the modal
          // cropModal.style.display = 'flex';
        };

        imageToCrop.src = objectUrl;
      };

      // Set orientation to landscape
      orientationLandscapeBtn.addEventListener("click", function () {
        if (!currentCropperInstance || currentOrientation === "landscape")
          return;

        currentOrientation = "landscape";
        updateOrientationToggle();

        // Update cropper aspect ratio
        currentCropperInstance.setAspectRatio(LANDSCAPE_RATIO);

        // Redraw safe area
        if (showSafeArea) {
          drawSafeArea();
        }
      });

      // Set orientation to portrait
      orientationPortraitBtn.addEventListener("click", function () {
        if (!currentCropperInstance || currentOrientation === "portrait")
          return;

        currentOrientation = "portrait";
        updateOrientationToggle();

        // Update cropper aspect ratio
        currentCropperInstance.setAspectRatio(PORTRAIT_RATIO);

        // Redraw safe area
        if (showSafeArea) {
          drawSafeArea();
        }
      });

      // Apply the crop and move to the next image
      cropApply.addEventListener("click", function () {
        if (!currentCropperInstance) return;

        // Determine dimensions based on orientation
        const width = currentOrientation === "landscape" ? 1067 : 600;
        const height = currentOrientation === "landscape" ? 600 : 1067;

        // Get the cropped canvas
        const croppedCanvas = currentCropperInstance.getCroppedCanvas({
          width: width,
          height: height,
          fillColor: "#fff",
        });

        // Save the orientation for this image
        cropOrientations[currentCropIndex] = currentOrientation;

        // Convert to blob
        croppedCanvas.toBlob(function (blob) {
          // Store the cropped version
          croppedFiles[currentCropIndex] = new File(
            [blob],
            selectedFiles[currentCropIndex].name,
            {
              type: "image/jpeg",
              lastModified: new Date().getTime(),
            },
          );

          // Clean up
          currentCropperInstance.destroy();
          currentCropperInstance = null;

          // Move to next image
          // startCropping(currentCropIndex + 1);
          closeEditModal();
        }, "image/jpeg");
      });

      // Cancel cropping and close the modal without saving
      cropCancel.addEventListener("click", function () {
        if (currentCropperInstance) {
          currentCropperInstance.destroy();
          currentCropperInstance = null;
        }
        closeEditModal();
      });

      // Close button on edit modal - also cleans up cropper
      editModalCloseBtn.addEventListener("click", function () {
        if (currentCropperInstance) {
          currentCropperInstance.destroy();
          currentCropperInstance = null;
        }
        closeEditModal();
      });

      const closeEditModal = () => {
        const cropModal = document.getElementById("edit-photos-modal");
        cropModal.classList.remove("active");
        imageToCrop.src = ""; // Clear the image source

        currentCropIndex = -1; // Reset the current crop index
        closeModal("edit-photos-modal");
        processThumbnails();
      };

      const updateUploadUI = () => {
        fileCountDisplay.textContent = `${selectedFiles.length}/${MAX_FILES} images selected`;
        const uploadArea = document.querySelector(`.upload-area`);
        const postSelectionInfo = document.querySelector(
          ".post-selection-info",
        );
        const removeAllFilesBtn = document.querySelector(
          ".remove-all-files-btn",
        );
        if (selectedFiles.length === 0) {
          removeAllFilesBtn.style.display = "none";
        } else {
          removeAllFilesBtn.style.display = "block";
        }
        if (selectedFiles.length === MAX_FILES) {
          uploadArea.style.display = "none";
          postSelectionInfo.style.display = "flex";
          uploadButton.disabled = false;
        } else {
          uploadArea.style.display = "flex";
          postSelectionInfo.style.display = "none";
          uploadButton.disabled = true;
        }
      };

      const compressImage = async (
        file,
        index,
        maxWidth = 2000,
        quality = 0.7,
      ) => {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error("Failed to read file"));
          reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;

            img.onload = () => {
              const canvas = document.createElement("canvas");
              const ctx = canvas.getContext("2d");

              const scale = Math.min(maxWidth / img.width, 1);
              canvas.width = img.width * scale;
              canvas.height = img.height * scale;

              ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

              // Save compressed version (preserving original aspect ratio)
              // The cropper modal handles the actual 16:9 or 9:16 crop
              canvas.toBlob(
                (blob) => {
                  const originalSizeInKB = Math.round(file.size / 1024);
                  const blobSizeInKB = Math.round(blob.size / 1024);
                  console.log("Original size:", originalSizeInKB, "KB");
                  console.log("Compressed size:", blobSizeInKB, "KB");
                  resolve(blob);
                },
                "image/jpeg",
                quality,
              );
            };
          };
          reader.readAsDataURL(file);
        });
      };

      // Create a default landscape crop from a compressed image blob
      const createDefaultCrop = (blob) => {
        return new Promise((resolve) => {
          const url = URL.createObjectURL(blob);
          const img = new Image();
          img.onload = () => {
            URL.revokeObjectURL(url);
            const targetRatio = LANDSCAPE_RATIO;
            let cropWidth, cropHeight;
            if (img.width / img.height > targetRatio) {
              cropHeight = img.height;
              cropWidth = cropHeight * targetRatio;
            } else {
              cropWidth = img.width;
              cropHeight = cropWidth / targetRatio;
            }
            const canvas = document.createElement("canvas");
            canvas.width = cropWidth;
            canvas.height = cropHeight;
            const ctx = canvas.getContext("2d");
            const sx = (img.width - cropWidth) / 2;
            const sy = (img.height - cropHeight) / 2;
            ctx.drawImage(
              img,
              sx,
              sy,
              cropWidth,
              cropHeight,
              0,
              0,
              cropWidth,
              cropHeight,
            );
            canvas.toBlob(
              (croppedBlob) => resolve(croppedBlob),
              "image/jpeg",
              0.7,
            );
          };
          img.src = url;
        });
      };

      const processNewFiles = async (files) => {
        console.log(`Processing new files: ${files.length} files selected`);
        if (files.length === 0) return;

        const initialLength = selectedFiles.length;
        for (let i = 0; i < files.length; i++) {
          console.log({ numberOfFiles: files.length, processed: i + 1 });
          const indexToInsert = initialLength + i;
          const compressed = await compressImage(files[i], indexToInsert);
          selectedFiles[indexToInsert] = compressed;

          // Create a default landscape crop so thumbnails show cropped preview
          croppedFiles[indexToInsert] = await createDefaultCrop(compressed);
          cropOrientations[indexToInsert] = "landscape";
        }

        processThumbnails();
        updateUploadUI();
      };

      const processThumbnails = () => {
        console.log(
          `Processing thumbnails for ${selectedFiles.length} selected files`,
        );

        const placeholderThumbnailContainer = document.querySelector(
          ".thumbnail-container",
        );
        const mainThumbnailContainer = document.querySelector(
          ".main-thumbnail-container",
        );

        // Clear existing thumbnails
        if (placeholderThumbnailContainer) {
          placeholderThumbnailContainer.innerHTML = "";
        }
        if (mainThumbnailContainer) {
          mainThumbnailContainer.innerHTML = "";
        }

        const maxFilesAdded = selectedFiles.length === MAX_FILES;
        const thumbnailContainer = maxFilesAdded
          ? mainThumbnailContainer
          : placeholderThumbnailContainer;

        const containers = new Array(selectedFiles.length);

        let imagesLoaded = 0;
        selectedFiles.forEach((file, index) => {
          const sourceFile = croppedFiles[index] || file;
          const reader = new FileReader();
          reader.onerror = () => {
            console.error(`Failed to read thumbnail for index: ${index}`);
            imagesLoaded++;
            // Still check if all readers completed so UI isn't stuck
            if (imagesLoaded === selectedFiles.length) {
              containers.forEach((container) => {
                if (container) thumbnailContainer.appendChild(container);
              });
            }
          };
          reader.onload = (e) => {
            // --- Action buttons ---
            const actionButtons = document.createElement("div");
            actionButtons.className = "thumbnail-action-buttons";

            // Edit button
            const editBtn = document.createElement("button");
            editBtn.className = "thumbnail-action-btn";
            editBtn.title = "Edit";
            editBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none"><path d="M4 13.5V16h2.5l7.06-7.06-2.5-2.5L4 13.5z" stroke="currentColor" stroke-width="1.5"/><path d="M14.06 6.44a1.5 1.5 0 0 0 0-2.12l-1.38-1.38a1.5 1.5 0 0 0-2.12 0l-1.06 1.06 3.5 3.5 1.06-1.06z" stroke="currentColor" stroke-width="1.5"/></svg>`;
            editBtn.onclick = (ev) => {
              ev.stopPropagation();
              console.log(`Editing button clicked for index: ${index}`);
              openModal(`edit-photos-modal`);
              startCropping(index);
            };

            // Delete button
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "thumbnail-action-btn";
            deleteBtn.title = "Remove";
            deleteBtn.innerHTML = `<svg viewBox="0 0 20 20" fill="none"><path d="M6 8v6m4-6v6m4-10v12a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V4m5-2h-2a2 2 0 0 0-2 2v2h8V4a2 2 0 0 0-2-2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
            deleteBtn.onclick = (ev) => {
              ev.stopPropagation();
              console.log(`Delete button clicked for index: ${index}`);
              removeFile(index);
            };

            actionButtons.appendChild(editBtn);
            actionButtons.appendChild(deleteBtn);
            const imgContainer = document.createElement("div");

            if (maxFilesAdded) {
              imgContainer.classList.add("main-thumbnail-img-container");
            } else {
              imgContainer.classList.add("placeholder-thumbnail-img-container");
            }

            imgContainer.style.position = "relative";
            imgContainer.style.display = "inline-flex";

            const imgElement = document.createElement("img");
            imgElement.src = e.target.result;
            imgElement.classList.add(
              maxFilesAdded ? "main-thumbnail" : "placeholder-thumbnail",
            );
            imgElement.onclick = (ev) => {
              ev.stopPropagation();
              console.log(`Thumbnail clicked for index: ${index}`);
              console.log(`Opening edit modal for index: ${index}`);
              openModal(`edit-photos-modal`);
              startCropping(index);
            };

            imgContainer.appendChild(imgElement);
            imgContainer.appendChild(actionButtons);

            // Place the container at the correct index
            containers[index] = imgContainer;
            imagesLoaded++;

            // When all images are loaded, append in order
            if (imagesLoaded === selectedFiles.length) {
              containers.forEach((container) => {
                if (container) thumbnailContainer.appendChild(container);
              });
              if (maxFilesAdded) {
                setTimeout(() => {
                  handleSafeAreaOverlay();
                }, 0);
              }
            }
          };
          reader.readAsDataURL(sourceFile);
        });
      };

      const handleSafeAreaOverlay = () => {
        const thumbnailContainers = document.querySelectorAll(
          ".main-thumbnail-img-container",
        );
        thumbnailContainers.forEach((thumbnail) => {
          // Calculate safe area dimensions
          const thumbnailImgElement = thumbnail.querySelector("img");
          const containerWidth = thumbnail.clientWidth;
          const containerHeight = thumbnail.clientHeight;
          const imgWidth = thumbnailImgElement.clientWidth;
          const imgHeight = thumbnailImgElement.clientHeight;

          // Calculate image position within the centered container
          const imgLeft = (containerWidth - imgWidth) / 2;
          const imgTop = (containerHeight - imgHeight) / 2;

          const safeWidth = imgWidth * SAFE_AREA_PERCENTAGE;
          const safeHeight = imgHeight * SAFE_AREA_PERCENTAGE;

          // Calculate safe area position (centered within the image)
          const safeLeft = imgLeft + (imgWidth - safeWidth) / 2;
          const safeTop = imgTop + (imgHeight - safeHeight) / 2;

          const safeAreaDiv = document.createElement("div");
          safeAreaDiv.classList.add("safe-area-overlay");
          safeAreaDiv.style.position = "absolute";
          safeAreaDiv.style.left = `${safeLeft}px`;
          safeAreaDiv.style.top = `${safeTop}px`;
          safeAreaDiv.style.width = `${safeWidth}px`;
          safeAreaDiv.style.height = `${safeHeight}px`;
          safeAreaDiv.style.border = `2px dashed ${SAFE_AREA_BORDER}`;
          safeAreaDiv.style.background = "transparent";
          safeAreaDiv.style.boxShadow = `0 0 0 9999px rgba(0, 0, 0, 0.25)`;
          safeAreaDiv.style.pointerEvents = "none";
          thumbnail.appendChild(safeAreaDiv);
        });
      };

      window.addEventListener("resize", () => {
        const modal = document.querySelector(".select-photos-modal.active");
        if (modal) {
          document
            .querySelectorAll(".safe-area-overlay")
            .forEach((el) => el.remove());
          handleSafeAreaOverlay();
        }
      });

      // Function to draw the safe area indicator
      function drawSafeArea() {
        if (!currentCropperInstance) return;

        // Remove existing safe area if any
        const existingSafeAreaContainer = document.querySelector(
          ".safe-print-container",
        );
        if (existingSafeAreaContainer) {
          existingSafeAreaContainer.remove();
        }

        // Get crop box dimensions
        const cropBox = currentCropperInstance.getCropBoxData();

        // Calculate safe area dimensions (smaller than the crop box)
        const safeWidth = cropBox.width * SAFE_AREA_PERCENTAGE;
        const safeHeight = cropBox.height * SAFE_AREA_PERCENTAGE;

        // Calculate position (centered within crop box)
        const safeLeft = (cropBox.width * (1 - SAFE_AREA_PERCENTAGE)) / 2; // cropBox.left + (cropBox.width - safeWidth) / 2;
        const safeTop = (cropBox.height * (1 - SAFE_AREA_PERCENTAGE)) / 2; // cropBox.top + (cropBox.height - safeHeight) / 2;

        // Create safe area contaner element
        const safeAreaContainer = document.createElement("div");
        safeAreaContainer.className = "safe-print-container";
        safeAreaContainer.style.position = "absolute";
        safeAreaContainer.style.left = `${cropBox.left}px`;
        safeAreaContainer.style.top = `${cropBox.top}px`;
        safeAreaContainer.style.width = `${cropBox.width}px`;
        safeAreaContainer.style.height = `${cropBox.height}px`;
        safeAreaContainer.style.pointerEvents = "none";

        const safeArea = document.createElement("div");
        safeArea.className = "safe-print-area";
        safeArea.style.position = "absolute";
        safeArea.style.left = `${safeLeft}px`;
        safeArea.style.top = `${safeTop}px`;
        safeArea.style.width = `${safeWidth}px`;
        safeArea.style.height = `${safeHeight}px`;
        safeArea.style.border = `2px dashed ${SAFE_AREA_BORDER}`;
        safeArea.style.background = "transparent";
        safeArea.style.boxShadow = "0 0 0 9999px rgba(0, 0, 0, 0.25)";
        safeArea.style.pointerEvents = "none";
        safeArea.style.zIndex = "2000";

        // Add a label to explain what this area represents
        const label = document.createElement("div");
        label.textContent = "Safe Print Area";
        label.style.position = "absolute";
        label.style.top = "-8px";
        label.style.left = "4px";
        label.style.backgroundColor = "rgba(0, 120, 255, 0.8)";
        label.style.color = "white";
        label.style.padding = "2px 6px";
        label.style.fontSize = "12px";
        label.style.borderRadius = "3px";
        safeAreaContainer.appendChild(label);

        safeAreaContainer.appendChild(safeArea);
        // Add to the cropper container
        const cropperContainer = document.querySelector(".cropper-container");
        cropperContainer.appendChild(safeAreaContainer);
      }

      const removeFile = (index) => {
        console.log(`Removing file at index: ${index}`);
        if (index < 0 || index >= selectedFiles.length) return;

        // Remove the file from selected files, cropped files, and orientations
        selectedFiles.splice(index, 1);
        croppedFiles.splice(index, 1);
        cropOrientations.splice(index, 1);

        if (selectedFiles.length === 0) {
          // If no files left, reset the file input
          actualFileInput.value = "";
        }

        // Update the UI
        processThumbnails();
        updateUploadUI();
      };

      const removeAllFiles = () => {
        console.log(`Removing all files.`);

        // Remove the files from selected files, cropped files, and orientations
        selectedFiles = [];
        croppedFiles = [];
        cropOrientations = [];

        actualFileInput.value = ""; // Clear the file input

        // Update the UI
        processThumbnails();
        updateUploadUI();
      };
    };
    document.addEventListener("DOMContentLoaded", function () {
      const uploadContainers = document.querySelectorAll(
        ".file-upload-container",
      );
      console.log({ hostName: window.location.hostname, uploadContainers });
      // Initialize image uploader
      uploadContainers.forEach((container) => {
        const productId = container.dataset.productId;
        if (productId) {
          initializeImageUploader(productId);
          console.log(`Initializing uploader for product ID: ${productId}`);
        }
      });
    });
  </script>
  <!--
    HTML for photo selection code.
  -->
  <button
    class="button select-photos-button"
    id="select-photos-button-{{ product.id }}"
    onclick="openModal(`select-photos-modal-{{ product.id }}`)"
  >
    Select photos
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="upload-icon"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M12 16V4m0 0l-4 4m4-4l4 4M4 16.5v1.75A2.25 2.25 0 006.25 20.5h11.5A2.25 2.25 0 0020 18.25V16.5"
      />
    </svg>
  </button>
</div>
<div id="select-photos-modal-{{ product.id }}" class="select-photos-modal">
  <button
    class="close-btn"
    onclick="closeModal(`select-photos-modal-{{ product.id }}`)"
    aria-label="Close modal"
    title="Close"
  >
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M6 18L18 6M6 6l12 12"
      ></path>
    </svg>
  </button>
  <!-- Content -->
  <div class="modal-content">
    <div class="main-thumbnail-container">
      <!-- Thumbnails will be dynamically added here -->
    </div>

    <!-- Drag & Drop Area -->
    <div class="upload-area">
      <input
        title="File Input"
        type="file"
        id="actual-file-input-{{ product.id }}"
        class="hidden-file-input"
        accept="image/*"
        multiple
      />
      <div class="upload-text">
        <h3>drag & drop</h3>
        <h3>your photos</h3>
        <p class="or-text">or</p>
      </div>

      <!-- Upload Button -->
      <button id="custom-upload-button-{{ product.id }}" class="upload-btn">
        Upload from camera roll or PC
      </button>
      <div id="upload-status-{{ product.id }}" class="upload-status"></div>
      <div id="file-count-display-{{ product.id }}" class="file-count">
        0/6 images selected
      </div>
    </div>
  </div>
  <!-- Header -->
  <div class="preview-container">
    <div class="modal-header">
      <div class="modal-title-container">
        <h2 class="modal-title">Selection preview</h2>
      </div>
      <p class="content-subtitle">Click pictures to resize or crop</p>
      <div class="thumbnail-container">
        <!-- Thumbnails will be dynamically added here -->
      </div>
    </div>
    <div class="post-selection-info">
      <div>
        Your 6 chosen images have been cropped to fit on rectangular magnets.
      </div>
      <div>
        The area outside the dotted lines will wrap around the edges of your
        magnets.
      </div>
      <div>Please review before placing your order.</div>
    </div>
    <!-- Footer -->
    <div class="modal-footer">
      <div
        id="media-upload-status-{{ product.id }}"
        class="upload-status"
      ></div>
      <div id="upload-progress" class="upload-progress">
        <div class="progress-bar-track">
          <div id="progress-bar-fill" class="progress-bar-fill"></div>
        </div>
        <span id="progress-text" class="progress-text">Uploading 0/6...</span>
      </div>
      <div id="upload-complete" class="upload-complete">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <p>Images uploaded successfully!</p>
      </div>
      <div id="remove-all-confirm" class="upload-confirm">
        <p class="upload-confirm-text">
          Remove all selected images? This cannot be undone.
        </p>
        <div class="upload-confirm-actions">
          <button id="remove-all-cancel-btn" class="confirm-cancel-btn">
            Go back
          </button>
          <button id="remove-all-confirm-btn" class="confirm-upload-btn">
            Yes, remove all
          </button>
        </div>
      </div>
      <div id="upload-confirm" class="upload-confirm">
        <p class="upload-confirm-text">
          Are your photos looking good? Once uploaded they cannot be changed.
        </p>
        <div class="upload-confirm-actions">
          <button id="confirm-cancel-btn" class="confirm-cancel-btn">
            Go back
          </button>
          <button id="confirm-upload-btn" class="confirm-upload-btn">
            Yes, upload
          </button>
        </div>
      </div>
      <div class="modal-footer-actions">
        <button id="remove-all-files-btn" class="remove-all-files-btn">
          Remove all files
        </button>
        <button id="upload-btn-main" class="add-to-cart-btn" disabled>
          Upload
        </button>
      </div>
    </div>
  </div>
  <div id="edit-photos-modal" class="edit-photos-modal">
    <div class="modal-header">
      <div class="modal-title-container">
        <h2 class="modal-title">Crop your image</h2>
        <button
          id="edit-modal-close-btn"
          class="close-btn"
          aria-label="Close modal"
          title="Close"
        >
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
      </div>
      <p class="content-subtitle">Click pictures to resize or crop</p>
      <div class="crop-container">
        <img id="image-to-crop" src="" alt="Image to crop" />
      </div>
      <div class="crop-controls">
        <div class="orientation-toggle">
          <button
            id="orientation-landscape"
            class="orientation-toggle-btn active"
            title="Landscape (16:9)"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="2" y="6" width="20" height="12" rx="2" />
            </svg>
            Landscape
          </button>
          <button
            id="orientation-portrait"
            class="orientation-toggle-btn"
            title="Portrait (9:16)"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="6" y="2" width="12" height="20" rx="2" />
            </svg>
            Portrait
          </button>
        </div>
        <button id="crop-cancel" class="crop-button cancel">Cancel</button>
        <button id="crop-apply" class="crop-button apply">Apply Crop</button>
      </div>
      <div class="crop-info">
        <p>
          The dashed blue box indicates the safe print area. Content outside
          this area may be trimmed during printing and magnet construction.
        </p>
      </div>
    </div>
  </div>
  <!-- This website uses Cropper.js by Chen Fengyuan -->
</div>
